name: Load Testing

on:
  # Run weekly on Monday at 2 AM UTC
  schedule:
    - cron: '0 2 * * 1'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      test_scenario:
        description: 'Test scenario to run'
        required: true
        type: choice
        options:
          - smoke
          - baseline
          - peak
          - all
        default: 'smoke'
      target_url:
        description: 'Target URL (leave empty for production)'
        required: false
        type: string

jobs:
  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && (github.event.inputs.test_scenario == 'smoke' || github.event.inputs.test_scenario == 'all')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
      
      - name: Run Smoke Test
        run: |
          if [ -n "${{ github.event.inputs.target_url }}" ]; then
            BASE_URL="${{ github.event.inputs.target_url }}" k6 run --out json=smoke-results.json load-tests/smoke.js
          else
            k6 run --out json=smoke-results.json load-tests/smoke.js
          fi
      
      - name: Upload Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-test-results
          path: smoke-results.json
          retention-days: 30

  baseline-test:
    name: Baseline Test
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.test_scenario == 'baseline' || github.event.inputs.test_scenario == 'all'))
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
      
      - name: Run Baseline Test
        run: |
          if [ -n "${{ github.event.inputs.target_url }}" ]; then
            BASE_URL="${{ github.event.inputs.target_url }}" k6 run --out json=baseline-results.json load-tests/baseline.js
          else
            k6 run --out json=baseline-results.json load-tests/baseline.js
          fi
      
      - name: Upload Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: baseline-test-results
          path: baseline-results.json
          retention-days: 30
      
      - name: Create Summary
        if: always()
        run: |
          echo "## Load Test Results (Baseline)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test completed. Download artifacts for detailed metrics." >> $GITHUB_STEP_SUMMARY

  peak-test:
    name: Peak Load Test
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && (github.event.inputs.test_scenario == 'peak' || github.event.inputs.test_scenario == 'all')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
      
      - name: Verify Staging Environment
        run: |
          if [ -z "${{ github.event.inputs.target_url }}" ]; then
            echo "ERROR: Peak load test requires a staging URL"
            echo "Please provide target_url in workflow dispatch"
            exit 1
          fi
      
      - name: Run Peak Load Test
        run: BASE_URL="${{ github.event.inputs.target_url }}" k6 run --out json=peak-results.json load-tests/peak.js
      
      - name: Upload Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: peak-test-results
          path: peak-results.json
          retention-days: 30
      
      - name: Create Summary
        if: always()
        run: |
          echo "## Load Test Results (Peak)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Peak load test completed against: ${{ github.event.inputs.target_url }}" >> $GITHUB_STEP_SUMMARY
          echo "Download artifacts for detailed metrics." >> $GITHUB_STEP_SUMMARY
